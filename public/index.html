<!-- mon-super-bot-stream/public/index.html -->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Stream</title>
    <!-- On inclut la librairie flv.js pour lire les streams -->
    <script src="https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js"></script>
    <style>
        :root {
            --background: #18181b;
            --surface: #27272a;
            --primary: #7289da;
            --primary-hover: #5b6eae;
            --danger: #f04747;
            --danger-hover: #d84040;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --border: #3f3f46;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--background); color: var(--text-primary); padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: auto; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        h1, h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        input, button { font-size: 1em; padding: 10px; border-radius: 3px; border: none; margin-right: 10px; }
        input { background: var(--background); color: var(--text-primary); border: 1px solid var(--border); }
        button { background: var(--primary); color: white; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background: var(--primary-hover); }
        .stop-button { background: var(--danger); }
        .stop-button:hover { background: var(--danger-hover); }
        .info-box { font-family: monospace; background: var(--background); padding: 10px; border-radius: 3px; word-break: break-all; margin-top: 5px; margin-bottom: 15px; cursor: pointer; border: 1px solid var(--border); }
        .info-box:hover { background: #3f3f46; }
        label { font-weight: bold; color: var(--text-secondary); }
        .stream-player-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .player-wrapper { position: relative; background: #000; width: 100%; padding-top: 56.25%; /* 16:9 Aspect Ratio */ }
        .player-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .offline-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; color: var(--text-secondary); }
        .stream-controls { padding: 15px; background: var(--surface); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard de Contrôle du Bot Stream</h1>

        <div id="key-section" class="card">
            <h2>Générateur de Clé de Stream</h2>
            <input type="text" id="stream-name-input" placeholder="Nom du stream (ex: mon_live)">
            <button onclick="generateKey()">Générer la clé</button>
            <div id="obs-info" style="display: none; margin-top: 15px;">
                <p><strong>À copier dans les paramètres de stream d'OBS :</strong></p>
                <label for="obs-server">Serveur :</label>
                <div id="obs-server" class="info-box" title="Cliquez pour copier"></div>
                <label for="obs-key">Clé de stream :</label>
                <div id="obs-key" class="info-box" title="Cliquez pour copier"></div>
            </div>
        </div>

        <h2>Streams Actifs</h2>
        <div id="active-streams">
            <p>Aucun stream actif pour le moment...</p>
        </div>
    </div>

    <script>
        // Objet pour garder en mémoire les lecteurs vidéo actifs
        let activePlayers = {};

        // Fonction pour générer la clé de stream via l'API
        async function generateKey() {
            const streamName = document.getElementById('stream-name-input').value;
            if (!streamName) {
                alert('Veuillez entrer un nom de stream.');
                return;
            }
            try {
                const response = await fetch(`/api/generate-key/${streamName}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Erreur: ${errorData.error || 'Impossible de générer la clé.'}`);
                    return;
                }
                const data = await response.json();

                // Affiche les deux champs pour OBS
                const serverUrl = `rtmp://${window.location.hostname}:1935/live`;
                const obsServerDiv = document.getElementById('obs-server');
                const obsKeyDiv = document.getElementById('obs-key');

                obsServerDiv.innerText = serverUrl;
                obsKeyDiv.innerText = data.streamKey;

                // Rend la section visible
                document.getElementById('obs-info').style.display = 'block';

            } catch (error) {
                console.error('Erreur lors de la génération de la clé:', error);
                alert('Erreur lors de la génération de la clé. Vérifiez la console.');
            }
        }

        // Fonction pour demander au bot de diffuser un stream
        async function startStreaming(streamName) {
            const guildId = prompt("Entrez l'ID du serveur (guilde) Discord :");
            const channelId = prompt("Entrez l'ID du salon vocal :");
            if (!guildId || !channelId) return;

            try {
                const response = await fetch('/api/start-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamName, guildId, channelId }),
                });
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                console.error('Erreur lors du démarrage de la diffusion:', error);
                alert('Erreur lors du démarrage de la diffusion. Vérifiez la console.');
            }
        }

        // Fonction pour arrêter un stream
        async function stopStreaming(streamName) {
            if (!confirm(`Voulez-vous vraiment arrêter le stream "${streamName}" ?\nCela déconnectera le streamer et le bot.`)) {
                return;
            }
            try {
                const response = await fetch('/api/stop-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamName }),
                });
                const result = await response.json();
                alert(result.message);
                fetchActiveStreams(); // Rafraîchir la liste
            } catch (error) {
                console.error('Erreur lors de l\'arrêt du stream:', error);
                alert('Erreur lors de l\'arrêt du stream.');
            }
        }

        // Met à jour la liste et l'état des streams de manière intelligente
        async function fetchActiveStreams() {
            try {
                const response = await fetch('/api/active-streams');
                const liveStreams = await response.json();
                const liveStreamNames = Object.keys(liveStreams);
                const container = document.getElementById('active-streams');
                const currentlyDisplayed = new Set(Object.keys(activePlayers));

                // 1. Gérer les streams qui se sont arrêtés
                for (const streamName of currentlyDisplayed) {
                    if (!liveStreamNames.includes(streamName)) {
                        console.log(`Stream ${streamName} est hors ligne. Nettoyage.`);
                        const player = activePlayers[streamName];
                        if (player) {
                            player.destroy();
                        }
                        delete activePlayers[streamName];
                        const card = document.getElementById(`stream-card-${streamName}`);
                        if (card) {
                            const overlay = card.querySelector('.offline-overlay');
                            if(overlay) overlay.style.display = 'flex'; // Affiche "HORS LIGNE"
                            // Optionnel: supprimer la carte après un délai
                            setTimeout(() => card.remove(), 30000);
                        }
                    }
                }

                // 2. Gérer les nouveaux streams
                for (const streamName of liveStreamNames) {
                    if (!currentlyDisplayed.has(streamName)) {
                        console.log(`Nouveau stream détecté: ${streamName}. Création du lecteur.`);
                        if (container.querySelector('p')) {
                            container.innerHTML = ''; // Nettoyer le message "Aucun stream"
                        }
                        createStreamCard(streamName, container);
                    }
                }

                // 3. Si plus aucun stream n'est actif
                if (liveStreamNames.length === 0 && container.children.length > 0) {
                    // Si on a décidé de ne pas supprimer les cartes, on ne fait rien ici
                    // Sinon, on nettoie tout
                } else if (liveStreamNames.length === 0 && container.children.length === 0) {
                    container.innerHTML = '<p>Aucun stream actif pour le moment...</p>';
                }

            } catch (error) {
                console.error('Erreur lors de la récupération des streams actifs:', error);
            }
        }

        function createStreamCard(streamName, container) {
            const card = document.createElement('div');
            card.className = 'stream-player-card';
            card.id = `stream-card-${streamName}`;
            card.innerHTML = `
                <div class="player-wrapper">
                    <video id="video-${streamName}" muted autoplay></video>
                    <div class="offline-overlay" style="display: none;">HORS LIGNE</div>
                </div>
                <div class="stream-controls">
                    <h3>${streamName}</h3>
                    <button onclick="startStreaming('${streamName}')">▶ Diffuser</button>
                    <button class="stop-button" onclick="stopStreaming('${streamName}')">■ Arrêter</button>
                </div>
            `;
            container.appendChild(card);

            if (flvjs.isSupported()) {
                const videoElement = document.getElementById(`video-${streamName}`);
                const flvPlayer = flvjs.createPlayer({
                    type: 'flv',
                    isLive: true,
                    url: `http://${window.location.hostname}:8000/live/${streamName}.flv`
                });
                flvPlayer.attachMediaElement(videoElement);
                flvPlayer.load();
                flvPlayer.play();
                activePlayers[streamName] = flvPlayer;
            }
        }

        // Lancement de la mise à jour périodique
        setInterval(fetchActiveStreams, 5000);
        // Premier chargement immédiat
        fetchActiveStreams();

        // Ajoute la fonctionnalité de copie au clic
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('info-box')) {
                navigator.clipboard.writeText(event.target.innerText).then(function() {
                    alert('Copié dans le presse-papiers !');
                }, function(err) {
                    console.error('Erreur lors de la copie: ', err);
                    alert('La copie a échoué.');
                });
            }
        });
    </script>
</body>
</html>
