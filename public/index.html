<!-- mon-super-bot-stream/public/index.html -->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Stream</title>
    <!-- On inclut la librairie flv.js pour lire les streams -->
    <script src="https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js"></script>
    <style>
        :root {
            --background: #18181b;
            --surface: #27272a;
            --primary: #7289da;
            --primary-hover: #5b6eae;
            --danger: #f04747;
            --danger-hover: #d84040;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --border: #3f3f46;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--background); color: var(--text-primary); padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: auto; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        h1, h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        input, button { font-size: 1em; padding: 10px; border-radius: 3px; border: none; margin-right: 10px; }
        input { background: var(--background); color: var(--text-primary); border: 1px solid var(--border); }
        button { background: var(--primary); color: white; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background: var(--primary-hover); }
        .stop-button { background: var(--danger); }
        .stop-button:hover { background: var(--danger-hover); }
        .info-box { font-family: monospace; background: var(--background); padding: 10px; border-radius: 3px; word-break: break-all; margin-top: 5px; margin-bottom: 15px; cursor: pointer; border: 1px solid var(--border); }
        .info-box:hover { background: #3f3f46; }
        label { font-weight: bold; color: var(--text-secondary); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        header h1 { margin: 0; }
        .header-nav a { background: var(--surface); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 15px; text-decoration: none; border-radius: 5px; transition: all 0.2s; margin-left: 10px; }
        .header-nav a:hover { background: var(--border); color: var(--primary); }
        .stream-player-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .player-wrapper { position: relative; background: #000; width: 100%; padding-top: 56.25%; /* 16:9 Aspect Ratio */ }
        .player-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }
        .offline-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; color: var(--text-secondary); }
        .stream-controls { padding: 15px; background: var(--surface); border-top: 1px solid var(--border); }
        .broadcast-controls { text-align: center; margin-bottom: 20px; }
        .stream-checkbox { margin-right: 10px; transform: scale(1.5); }
        #keys-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #keys-table th, #keys-table td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .hide-button { background: #ffc107; color: #000; }
        .hide-button:hover { background: #e0a800; }
        #keys-table th { background-color: var(--background); }
        .status-active { color: #28a745; font-weight: bold; }
        .status-suspended { color: #dc3545; font-weight: bold; }

        /* Masquer les contrôles vidéo non désirés sur le dashboard aussi */
        video::-webkit-media-controls-play-button,
        video::-webkit-media-controls-timeline,
        video::-webkit-media-controls-current-time-display,
        video::-webkit-media-controls-time-remaining-display {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dashboard Admin</h1>
            <nav class="header-nav">
                <a href="/">Voir le site public</a>
                <a href="#" onclick="logout()">Se Déconnecter</a>
            </nav>
        </header>

        <div id="key-section" class="card">
            <h2>Créer une nouvelle clé</h2>
            <input type="text" id="stream-name-input" placeholder="Nom du stream (ex: mon_live)">
            <button onclick="createKey()">Créer la clé</button>
        </div>

        <div class="card">
            <h2>Gestion des Clés</h2>
            <table id="keys-table">
                <thead>
                    <tr>
                        <th>Nom du Stream</th><th>Clé de Stream</th><th>Statut</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody id="keys-tbody"></tbody>
            </table>
        </div>

        <h2>Streams Actifs</h2>
        <div class="broadcast-controls card">
            <h3>Contrôle de la Diffusion</h3>
            <button onclick="startBroadcastingSelected()">▶ Diffuser la sélection</button>
            <button class="stop-button" onclick="stopBroadcasting()">■ Arrêter la diffusion</button>
        </div>
        <div id="active-streams">
            <p>Aucun stream actif pour le moment...</p>
        </div>
    </div>

    <script>
        // Objet pour garder en mémoire les lecteurs vidéo actifs
        let activePlayers = {};

        function logout() {
            // Astuce pour forcer la déconnexion avec basic-auth
            const xhr = new XMLHttpRequest();
            xhr.open("GET", "/admin", true, "logout", "logout");
            xhr.send();
            xhr.onreadystatechange = () => { if (xhr.readyState == 4) { location.reload(); } }
        }

        // Fonction pour créer une nouvelle clé
        async function createKey() {
            const streamName = document.getElementById('stream-name-input').value;
            if (!streamName) {
                alert('Veuillez entrer un nom de stream.');
                return;
            }
            try {
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamName }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Erreur serveur');
                fetchKeys(); // Rafraîchir la liste des clés
                document.getElementById('stream-name-input').value = '';
            } catch (error) {
                console.error('Erreur lors de la génération de la clé:', error);
                alert('Erreur lors de la génération de la clé. Vérifiez la console.');
            }
        }

        // Fonction pour demander au bot de diffuser les streams sélectionnés
        async function startBroadcastingSelected() {
            const selectedStreams = Array.from(document.querySelectorAll('.stream-checkbox:checked')).map(cb => cb.value);
            if (selectedStreams.length === 0) {
                alert("Veuillez sélectionner au moins un stream à diffuser.");
                return;
            }

            try {
                const response = await fetch('/api/broadcast-streams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamNames: selectedStreams }),
                });
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                console.error('Erreur lors du démarrage de la diffusion:', error);
                alert('Erreur lors du démarrage de la diffusion.');
            }
        }

        // Fonction pour arrêter la diffusion du bot
        async function stopBroadcasting() {
             if (!confirm(`Voulez-vous vraiment arrêter la diffusion du bot ?`)) return;
             const response = await fetch('/api/stop-broadcast', { method: 'POST' });
             const result = await response.json();
             alert(result.message);
        }

        // Fonction pour masquer/démasquer un stream
        async function toggleStreamVisibility(streamName, shouldHide, event) {
            const button = event.target;
            try {
                await fetch(`/api/streams/${streamName}/hide`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hidden: shouldHide }),
                });
                // Mettre à jour l'interface immédiatement sans attendre le prochain fetch
                button.innerText = shouldHide ? 'Démasquer' : 'Masquer';
                button.onclick = (event) => toggleStreamVisibility(streamName, !shouldHide, event);
            } catch (error) {
                console.error('Erreur lors du masquage du stream:', error);
                alert('Erreur lors du masquage du stream.');
            }
        }

        // --- Fonctions de gestion des clés ---
        async function fetchKeys() {
            const response = await fetch('/api/keys');
            const keys = await response.json();
            const tbody = document.getElementById('keys-tbody');
            tbody.innerHTML = '';
            const serverUrl = `rtmp://82.65.62.132:1935/live`; // Utilise l'IP publique

            keys.forEach(key => {
                const row = tbody.insertRow();
                const toggleStatusText = key.status === 'active' ? 'Suspendre' : 'Activer';
                const newStatus = key.status === 'active' ? 'suspended' : 'active';

                row.innerHTML = `
                    <td>${key.name}</td>
                    <td>
                        <div class="info-box" title="Cliquez pour copier la clé">${key.key}</div>
                        <small>Serveur: <span class="info-box" title="Cliquez pour copier le serveur">${serverUrl}</span></small>
                    </td>
                    <td><span class="status-${key.status}">${key.status}</span></td>
                    <td>
                        <button onclick="toggleKeyStatus('${key.name}', '${newStatus}')">${toggleStatusText}</button>
                        <button class="stop-button" onclick="deleteKey('${key.name}')">Supprimer</button>
                    </td>
                `;
            });
        }

        async function deleteKey(streamName) {
            if (!confirm(`Voulez-vous vraiment supprimer définitivement la clé pour "${streamName}" ?`)) return;
            try {
                await fetch(`/api/keys/${streamName}`, { method: 'DELETE' });
                fetchKeys();
            } catch (error) {
                alert('Erreur lors de la suppression.');
            }
        }

        async function toggleKeyStatus(streamName, newStatus) {
            try {
                await fetch(`/api/keys/${streamName}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });
                fetchKeys();
            } catch (error) {
                alert('Erreur lors du changement de statut.');
            }
        }


        // Met à jour la liste et l'état des streams
        async function fetchActiveStreams() {
            try {
                const response = await fetch('/api/active-streams');
                const liveStreams = await response.json();
                const liveStreamNames = Object.keys(liveStreams);
                const container = document.getElementById('active-streams');
                const currentlyDisplayed = new Set(Object.keys(activePlayers));

                // 1. Gérer les streams qui se sont arrêtés
                for (const streamName of currentlyDisplayed) {
                    if (!liveStreamNames.includes(streamName)) {
                        console.log(`Stream ${streamName} est hors ligne. Nettoyage.`);
                        const player = activePlayers[streamName];
                        if (player) {
                            player.destroy();
                        }
                        delete activePlayers[streamName];
                        const card = document.getElementById(`stream-card-${streamName}`);
                        if (card) {
                            card.remove();
                        }
                    }
                }

                // 2. Gérer les nouveaux streams
                for (const streamName of liveStreamNames) {
                    if (!currentlyDisplayed.has(streamName)) {
                        console.log(`Nouveau stream détecté: ${streamName}. Création du lecteur.`);
                        if (container.querySelector('p')) {
                            container.innerHTML = ''; // Nettoyer le message "Aucun stream"
                        }

                        // Créer la carte du lecteur
                        const card = document.createElement('div');
                        card.className = 'stream-player-card';
                        card.id = `stream-card-${streamName}`;
                        card.innerHTML = `
                            <div class="player-wrapper">
                                <video id="video-${streamName}" autoplay controls muted></video>
                                <div class="offline-overlay" style="display: none;">HORS LIGNE</div>
                            </div>
                            <div class="stream-controls">
                                <h3><input type="checkbox" class="stream-checkbox" value="${streamName}" id="cb-${streamName}"> <label for="cb-${streamName}">${streamName}</label></h3>
                                <button class="hide-button" onclick="toggleStreamVisibility('${streamName}', ${!liveStreams[streamName].hidden}, event)">
                                    ${liveStreams[streamName].hidden ? 'Démasquer' : 'Masquer'}
                                </button>
                            </div>
                        `;
                        container.appendChild(card);

                        // Initialiser le lecteur flv.js
                        if (flvjs.isSupported()) {
                            const videoElement = document.getElementById(`video-${streamName}`);
                            const flvPlayer = flvjs.createPlayer({
                                type: 'flv',
                                isLive: true,
                                url: `http://${window.location.hostname}:8000/live/${streamName}.flv`
                            });
                            flvPlayer.attachMediaElement(videoElement);
                            flvPlayer.load();
                            flvPlayer.play();
                            activePlayers[streamName] = flvPlayer;
                        }
                    } else {
                        // 3. Mettre à jour les streams existants (pour le statut 'hidden')
                        const streamData = liveStreams[streamName];
                        const hideButton = document.querySelector(`#stream-card-${streamName} .hide-button`);
                        if (hideButton) {
                            hideButton.innerText = streamData.hidden ? 'Démasquer' : 'Masquer';
                            // On met à jour la fonction onclick pour qu'elle ait la bonne valeur de 'hidden'
                            hideButton.onclick = (event) => toggleStreamVisibility(streamName, !streamData.hidden, event);
                        }
                    }
                }
                // 4. Si plus aucun stream n'est actif et qu'il n'y a pas de cartes
                if (liveStreamNames.length === 0 && container.children.length === 0) {
                    container.innerHTML = '<p>Aucun stream actif pour le moment...</p>';
                }
            } catch (error) {
                console.error('Erreur lors de la récupération des streams actifs:', error);
            }
        }

        // Lancement de la mise à jour périodique
        setInterval(fetchActiveStreams, 5000);
        // Premier chargement immédiat
        fetchActiveStreams();
        fetchKeys();

        // Ajoute la fonctionnalité de copie au clic
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('info-box')) {
                navigator.clipboard.writeText(event.target.innerText).then(function() {
                    alert('Copié dans le presse-papiers !');
                }, function(err) {
                    console.error('Erreur lors de la copie: ', err);
                    alert('La copie a échoué.');
                });
            }
        });
    </script>
</body>
</html>
