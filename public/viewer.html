<!-- mon-super-bot-stream/public/viewer.html -->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Visionneuse de Streams</title>
    <script src="https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js"></script>
    <style>
        :root {
            --background: #0d1117;
            --surface: #161b22;
            --primary: #58a6ff;
            --primary-glow: rgba(88, 166, 255, 0.5);
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border: #30363d;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--background); color: var(--text-primary); margin: 0; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; max-width: 1600px; margin: 0 auto 40px auto; }
        header h1 { font-size: 2.5em; color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); margin: 0; }
        .admin-button { background: var(--surface); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 15px; text-decoration: none; border-radius: 5px; transition: all 0.2s; }
        .admin-button:hover { background: var(--border); color: var(--primary); }
        #stream-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; max-width: 1600px; margin: auto; }
        .stream-player-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; }
        .stream-player-card:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--primary-glow); }
        .player-wrapper { position: relative; background: #000; width: 100%; padding-top: 56.25%; }
        .player-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }
        .stream-title { padding: 15px; font-size: 1.2em; font-weight: bold; }
        .hidden-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; color: var(--text-secondary); z-index: 10; }
        .no-streams { text-align: center; font-size: 1.5em; color: var(--text-secondary); }
        /* Styles pour la vue focus */
        .focused-view #stream-grid { display: block; }
        .focused-view .stream-player-card { cursor: default; }
        .focused-view .stream-player-card:hover { transform: none; box-shadow: none; }

        /* Masquer les contrôles vidéo non désirés */
        video::-webkit-media-controls-play-button,
        video::-webkit-media-controls-timeline,
        video::-webkit-media-controls-current-time-display,
        video::-webkit-media-controls-time-remaining-display,
        video::-webkit-media-controls-fullscreen-button {
            display: none !important;
        }
    </style>
</head>
<body>

    <header>
        <h1>Streams en Direct</h1>
        <a href="/admin" class="admin-button">Espace Admin</a>
    </header>

    <div id="stream-grid">
        <p class="no-streams">Aucun stream en direct pour le moment...</p>
    </div>

    <script>
        let activePlayers = {};
        let liveStreams = {};

        async function fetchAndDisplayStreams() {
            try {
                const response = await fetch('/api/public/streams');
                const liveStreams = await response.json();
                const liveStreamNames = Object.keys(liveStreams);
                const grid = document.getElementById('stream-grid');
                const currentlyDisplayed = new Set(Object.keys(activePlayers));
                const isFocused = document.body.classList.contains('focused-view');

                // Mettre à jour l'état "masqué" des streams déjà affichés
                for (const streamName of currentlyDisplayed) {
                    if (liveStreams[streamName]) {
                        const card = document.getElementById(`stream-card-${streamName}`);
                        const overlay = card.querySelector('.hidden-overlay');
                        if (liveStreams[streamName].hidden && !overlay) {
                            const playerWrapper = card.querySelector('.player-wrapper');
                            playerWrapper.insertAdjacentHTML('afterbegin', '<div class="hidden-overlay">Stream masqué temporairement</div>');
                        } else if (!liveStreams[streamName].hidden && overlay) {
                            overlay.remove();
                        }
                    }
                }

                // Gérer les streams qui se sont arrêtés
                for (const streamName of currentlyDisplayed) {
                    if (!liveStreamNames.includes(streamName)) {
                        console.log(`Stream ${streamName} est hors ligne. Nettoyage.`);
                        activePlayers[streamName]?.destroy();
                        delete activePlayers[streamName];
                        document.getElementById(`stream-card-${streamName}`)?.remove();
                    }
                }

                // Gérer les nouveaux streams
                for (const streamName of liveStreamNames) {
                    if (!currentlyDisplayed.has(streamName) && !isFocused) {
                        console.log(`Nouveau stream détecté: ${streamName}.`);
                        if (grid.querySelector('p')) {
                            grid.innerHTML = '';
                        }
                        createStreamCard(streamName, grid, liveStreams);
                    }
                }

                if (liveStreamNames.length === 0 && grid.children.length === 0) {
                    grid.innerHTML = '<p class="no-streams">Aucun stream en direct pour le moment...</p>';
                }

                // Si un stream est spécifié dans l'URL, on le fait défiler
                const urlParams = new URLSearchParams(window.location.search);
                const focusedStreamName = urlParams.get('stream');
                if (focusedStreamName && liveStreamNames.includes(focusedStreamName)) {
                    focusOnStream(focusedStreamName, liveStreams);
                }

            } catch (error) {
                console.error("Erreur lors de la récupération des streams:", error);
            }
        }

        function createStreamCard(streamName, container, allStreams) {
            const isHidden = allStreams[streamName].hidden;
            const card = document.createElement('div');
            card.className = 'stream-player-card';
            card.id = `stream-card-${streamName}`;
            card.onclick = () => focusOnStream(streamName, allStreams);
            card.innerHTML = `
                <div class="player-wrapper">
                    ${isHidden ? '<div class="hidden-overlay">Stream masqué temporairement</div>' : ''}
                    <video id="video-${streamName}" autoplay controls muted></video>
                </div>
                <div class="stream-title">${streamName}</div>
            `;
            container.appendChild(card);

            if (flvjs.isSupported() && !isHidden) {
                const videoElement = document.getElementById(`video-${streamName}`);
                // Si le stream est masqué, on ne charge pas le lecteur.
                if (!videoElement) {
                    console.warn(`Élément vidéo pour ${streamName} non trouvé.`);
                    return;
                }
                // Logique pour l'audio unique
                videoElement.onplay = () => {
                    document.querySelectorAll('video').forEach(v => {
                        if (v !== videoElement) v.muted = true;
                    });
                };
                const flvPlayer = flvjs.createPlayer({
                    type: 'flv',
                    isLive: true,
                    url: `http://${window.location.hostname}:8000/live/${streamName}.flv`
                });
                flvPlayer.attachMediaElement(videoElement);
                flvPlayer.load();
                flvPlayer.play();
                activePlayers[streamName] = flvPlayer;
            }
        }

        function focusOnStream(streamName, allStreams) {
            document.body.classList.add('focused-view');
            const grid = document.getElementById('stream-grid');
            grid.innerHTML = ''; // Vide la grille
            createStreamCard(streamName, grid, allStreams);

            // Change le titre et ajoute un bouton de retour
            const header = document.querySelector('header');
            header.innerHTML = `
                <h1>${streamName}</h1>
                <a href="javascript:showGridView()" class="admin-button">Retour à la grille</a>
            `;
        }

        function showGridView() {
            document.body.classList.remove('focused-view');
            const header = document.querySelector('header');
            header.innerHTML = `
                <h1>Streams en Direct</h1>
                <a href="/admin" class="admin-button">Espace Admin</a>
            `;
            fetchAndDisplayStreams(); // Relance un rafraîchissement complet de la grille
        }

        // Lancement
        setInterval(fetchAndDisplayStreams, 2000); // Intervalle réduit à 2 secondes
        fetchAndDisplayStreams();
    </script>

</body>
</html>